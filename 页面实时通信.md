#### 实时通信
即时通信：服务器能够主动的，快速的将消息推送给客户端，不需要浏览器主动询问。
##### 一、短轮询：
客户端定时间隔向服务器查询最新数据，实现方式为setInterval+ajax，实现简单，
缺点是：
1、频繁请求，资源浪费，无消息时会造成大量的无效HTTP连接
2、实时性差，取决于轮询间隔，间隔短压力大，间隔长实时性差

##### 二、长轮询
客户端发起请求后，服务端不立即响应，挂起请求，等有相应再返回，客户端收到响应立即发起下一个
1、每个挂起的服务都会占用服务器资源，高并发服务器压力大
2、浏览器对统一域名请求个数限制，会导致阻塞其他请求

##### 三、SSE
Server  Sent Events
html5标准，允许服务器向客户端推送数据，是一种单向通道，只能从服务端到客户端
原理：
客户端使用EventSourceAPI创建一个到服务器的持久连接，服务器返回的content-type是text/event-stream,并遵循特定格式推送数据流
优点：
浏览器支持，使用简单
自动重连：内置自动重连机制

缺点：
只能单项通信，从服务端到客户端
协议限制：只能使用文本数据，不支持二进制数据(如文件流)
兼容性：IE完全不支持

##### 四、websocket
html5提供的全双工双向通信，再单个TCP协议上提供双向通信通道

原理：客户端和服务端通过一个HTTP请求进行握手升级协议，将协议从HTTP升级成ws://或者wss://，此后，双方可以在任何时间向对方发送数据，不受请求-响应模式的限制

优点：
真正双向：全双工通信，实时性高
高效：建立一次连接后，数据传输头部开销小，
支持二进制数据：可以传输文本和二进制数据

缺点：
协议复杂：需要服务器专门支持websocket协议
无自动重连：连接断开后需要自己实现重连逻辑

##### webTRC
实现浏览器之间的实时音视频通信和数据通信，允许点对点直接通信，数据不经过服务器中转，延迟低

适用：视频会议，在线教育，屏幕共享
特点：通信复杂，需要信令服务器协助建立P2P连接，建立后数据传递延迟低

##### SSE和WebSocket的区别，如何选择
SSE:单向服务器推流给客户端，基于HTTP，内置重连
WebSocket：双向通信，独立协议，需要自己实现重连

选择：只需要服务器单向推送-SSE
双向通信选择WebSocket

##### WebSocket握手过程
客户端发起带有特殊请求头的HTTP请求
```
GET /chat HTTP/1.1
Host: server.example.com
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
Sec-WebSocket-Version: 13
```
服务端返回101状态码表示协议切换成功
```
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
```
通信就使用WebSocket数据帧协议

##### 前端创建一个WebSocket连接
```
const ws = new WebSocket('ws://example.com')
ws.onopen = ()=>{

}
ws.onmessage = ()=>{

}
ws.onclose = ()=>{

}
es.onerror = ()=>{

}
ws.send('ping')

//短线重连逻辑
function connent(){
  const ws = new WebSocket(url)
  ws.onclose = ()=>{
    setTimeout(connect,300)
  }
}
```

##### 如何保证WebSocket连接的安全性
1、使用wss://协议，具有安全的ws协议
2、在服务端对Origin头进行校验，防止跨站WebSocket劫持，
3、对传输的数据进行加密或使用身份认证

##### 弱网环境下，webSocket断开，如何提升用户体验
1、实现断线自动重连机制，并采用指数退避策略，重连时间逐渐边长
2、提供UI提示：断连情况下提供网络已断开提示
3、连接断开期间，本地缓存用户发送的消息，待连接后重新发送(客服业务不这样做)
4、心跳监测：心跳包ping，定时监测连接


##### SSE为什么可以自动重连，WebSocket需要手动实现
SSE基于HTTP,浏览器在实现SSE时，内部封装了重连逻辑，
而WebSocket是独立的更底层的TCP协议，浏览器只提供了基础的API，不包含业务逻辑(如重连)，需要开发者手动开发 

SSE自动重连的详细原理：
SSE的本质是一个长久的HTTP连接，服务器通过这个连接持续发送数据流，自动重连是客户端行为的一部分，是底层协议的高级抽象，专门为服务端到客户端的单向数据流场景设计的，

客户端使用EventSourceAPI创建指向SSE终端的连接，服务器的响应数据必须是text/event-stream数据流，服务器返回的数据遵循简单的文本格式，

```
event: userConnected
data: {"username": "Alice"}
id: 12345

data: This is a message
id: 12346

: this is a comment
retry: 10000  // <-- 关键！服务器可以建议重连延迟
```
##### 当浏览器监测到以下情况，会触发重连机制
1、网络连接丢失(客户端离线)
2、服务器主动关闭连接
3、数据流解析错误

##### SSE自动重连的工作流程
1、连接中断
2、内置计时器：EventSource内部有一个计时器，延迟时间决定因素有：
I、服务器建议：服务器数据流有retry字段的时间
II、设置的默认值：服务器没有指定，浏览器默认延迟重连

3、发起新请求：计时器结束，重新发起请求，全新的HTTP连接到SSE终端
4、携带Last-Event-ID：实现消息续传的关键，如果之前的消息流中包含id字段，浏览器会在重连请求的HTTP头中自动添加Last-Event-ID，值是最后接收到的事件的ID
GET /events HTTP/1.1
Host: api.example.com
Accept: text/event-stream
Last-Event-ID: 12346  // <-- 浏览器自动添加
5、服务器处理：收到携带Last-Event-ID头请求，服务器就从这个ID之后发送接下来的消息，避免客户端中间数据丢失

##### WebSocket需要自动重连的原理
1、建立连接
客户端发送HTTP Upgrate请求与服务器握手，将协议从HTTP升级成WebSocket
通信成功后，HTTP被劫持，底层使用同一个TCP连接，但是通信协议变成了WebSocket数据帧协议
2、连接中断的本质
WebSocket连接依赖于一个单一的，持久的TCP连接，可能因为
1、网络中断
2、服务器进程崩溃
3、中间代理或者防火墙断开空闲连接
4、客户端休眠或者切换网络
以上原因断开
当这个TCP断开时，整个WebSocket会话就彻底结束。


