## 构建页面监控系统，监控页面报错信息，形成日志，从而方便排查问题与问题定位
构建统一的日志监控类，实现log,error,info,getAllLogs等方法，方法功能为在数据库示例中添加日志数据，不同方法是不同类型。
构建indexDB数据库，用于存储日志信息，实现日志的增删改查功能，防抖存储，不是每一次都存储日志，先维护日志队列，到一定长度或者时间再批量存储日志队列到数据库


## 借助webWorker+indexDB实现页面日志监控
统一构建日志类logger,实现logger类


#### logger文件
构建Logger类，实现log,error,info,debug,getAllLogs方法，方法功能为在数据库示例中添加日志数据，不同方法是不同类型。
导出exportLog方法，按快捷键导出日志

```
import dayjs from "dayjs";
import { getWorker } from "./logWorker";

import { setMessageCallback } from "./logWorker";

// 设置全局消息处理
setMessageCallback((response) => {
  if (response.type === "error") {
    console.error("Worker 错误:", response.error);
  } else if (response.type === "add" && response.success) {
    console.log("日志添加成功");
  } else if (response.type === "save" && response.logs) {
    console.log("获取到日志数据:", response.logs);
  } else if (response.type === "test" && response.success) {
    console.log("Worker 测试成功");
  }
});

const addLog = (type, message, meta = {}) => {
  console.log("准备添加日志:", { type, message, meta });
  const worker = getWorker();

  if (!worker) {
    console.error("Worker 未初始化");
    return;
  }

  const data = {
    type: "add",
    payload: {
      type,
      message,
      meta,
      timestamp: dayjs().format("YYYY-MM-DD HH:mm:ss"),
    },
  };

  try {
    worker.postMessage(data);
    console.log("日志消息已发送:", data);
  } catch (error) {
    console.error("发送日志消息失败:", error);
  }
};

const saveLog = (type, message, meta = {}) => {
  const worker = getWorker();

  if (!worker) {
    console.error("Worker 未初始化");
    return;
  }

  const data = {
    type: "save",
    payload: {
      type,
      message,
      meta,
      timestamp: dayjs().format("YYYY-MM-DD HH:mm:ss"),
    },
  };

  try {
    worker.postMessage(data);
    console.log("保存日志请求已发送:", data);
  } catch (error) {
    console.error("发送保存日志请求失败:", error);
  }
};

class Logger {
  log(message, meta = {}) {
    return addLog("log", message, meta);
  }

  info(message, meta = {}) {
    return addLog("info", message, meta);
  }

  warn(message, meta = {}) {
    return addLog("warn", message, meta);
  }

  error(message, meta = {}) {
    const errorMeta = {
      ...meta,
      stack: new Error().stack,
    };
    return addLog("error", message, errorMeta);
  }

  debug(message, meta = {}) {
    return addLog("debug", message, meta);
  }

  getAllLogs() {
    const data = {
      type: "save",
      payload: {
        type: "getAllLogs",
        message: "get all logs",
        meta: {},
        timestamp: dayjs().format("YYYY-MM-DD HH:mm:ss"),
      },
    };
    getWorker().postMessage(data);
  }
}

const logger = new Logger();

export default logger;
export { Logger };

export const exportLog = () => {
  try {
    const data = logger.getAllLogs();

    const str = JSON.stringify(data);

    const url = URL.createObjectURL(new Blob([str]));

    const $a = document.createElement("a");
    $a.href = url;

    $a.download = `Log__${dayjs().format("YYYYMMDDHHmmss")}${Math.random()
      .toString(32)
      .slice(2, 5)}.log`;

    document.body.appendChild($a);

    $a.click();

    document.body.removeChild($a);
  } catch (e) {
    console.log(e);
    return Promise.reject(e);
  }
};

```

#### logWorker.js文件
构建logWorker文件，实现worker单例类，处理日志添加回调函数
```
let worker = null;
let messageCallback = null;

const createWorker = () => {
  try {
    // 直接使用相对路径
    const workerUrl = new URL("./worker.js", import.meta.url);
    console.log("Worker URL:", workerUrl.toString());

    const newWorker = new Worker(workerUrl, {
      name: "LogWorker",
    });

    // 设置错误处理
    newWorker.onerror = (error) => {
      console.error("Worker 错误:", error);
    };

    // 设置消息处理
    newWorker.onmessage = (event) => {
      console.log("Worker 接收到响应:", event.data);
      // 转发消息给回调函数
      if (messageCallback) {
        messageCallback(event.data);
      }
    };

    console.log("Worker 创建成功");
    return newWorker;
  } catch (error) {
    console.error("Worker 创建失败:", error);
    return null;
  }
};

// 获取 Worker 实例
export const getWorker = () => {
  if (!worker) {
    worker = createWorker();
    if (worker) {
      // 发送测试消息
      worker.postMessage({
        type: "test",
        payload: {
          type: "test",
          message: "Worker 初始化测试",
          timestamp: new Date().toISOString(),
        },
      });
    }
  }
  return worker;
};

// 设置消息回调
export const setMessageCallback = (callback) => {
  messageCallback = callback;
};

```

#### worker.js文件
实现worker逻辑，处理日志添加和保存逻辑
```
console.log("Worker 脚本开始执行");

// LogStorage 类定义
class LogStorage {
  constructor() {
    this.dbName = "LogDatabase";
    this.storeName = "logs";
    this.version = 1;
    this.db = null;
    this.initialized = false;
  }

  async init() {
    return new Promise((resolve, reject) => {
      if (this.initialized) {
        resolve(this);
        return;
      }

      const request = indexedDB.open(this.dbName, this.version);

      request.onerror = () => reject(request.error);
      request.onsuccess = () => {
        this.db = request.result;
        this.initialized = true;
        resolve(this);
      };

      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains(this.storeName)) {
          const store = db.createObjectStore(this.storeName, {
            keyPath: "id",
            autoIncrement: true,
          });
          store.createIndex("timestamp", "timestamp", { unique: false });
          store.createIndex("level", "level", { unique: false });
        }
      };
    });
  }

  async addLog(level, message, meta = {}) {
    if (!this.initialized) {
      await this.init();
    }

    const logEntry = {
      level,
      message,
      meta,
      timestamp: new Date().toISOString(),
    };

    return new Promise((resolve, reject) => {
      try {
        const transaction = this.db.transaction([this.storeName], "readwrite");
        const store = transaction.objectStore(this.storeName);
        const request = store.add(logEntry);

        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      } catch (error) {
        reject(error);
      }
    });
  }

  async getLogs() {
    if (!this.initialized) {
      await this.init();
    }

    return new Promise((resolve, reject) => {
      try {
        const transaction = this.db.transaction([this.storeName], "readonly");
        const store = transaction.objectStore(this.storeName);
        const request = store.getAll();

        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      } catch (error) {
        reject(error);
      }
    });
  }
}

// 设置全局错误处理
self.onerror = function (error) {
  console.error("Worker 全局错误:", error);
};

self.addEventListener("error", function (e) {
  console.error("Worker 错误事件:", e.error);
});

let logStorage = null;

const initDB = async () => {
  try {
    if (!logStorage) {
      logStorage = new LogStorage();
      await logStorage.init();
    }
    return logStorage;
  } catch (error) {
    console.error("LogStorage 初始化失败:", error);
    throw error;
  }
};

const addLog = async (log) => {
  try {
    const storage = await initDB();
    const { type, message, meta } = log;
    // const msg = pack(message);
    await storage.addLog(type, message, meta);
    console.log("日志添加成功:", log);
    return true;
  } catch (error) {
    console.error("添加日志失败:", error);
    throw error;
  }
};

const getLogs = async () => {
  try {
    const storage = await initDB();
    const logs = await storage.getLogs();
    console.log("获取日志成功, 数量:", logs.length);
    return logs;
  } catch (error) {
    console.error("获取日志失败:", error);
    throw error;
  }
};

self.onmessage = async function (e) {
  console.log("Worker 收到消息:", e.data);
  const { type, payload } = e.data;

  try {
    // 确保 LogStorage 已初始化
    await initDB();

    if (type === "add") {
      await addLog(payload);
      self.postMessage({ type: "add", success: true });
    } else if (type === "save") {
      const logs = await getLogs();
      self.postMessage({ type: "save", logs });
    } else if (type === "test") {
      self.postMessage({ type: "test", success: true });
    } else {
      console.warn("未知的消息类型:", type);
    }
  } catch (error) {
    console.error("Worker 错误:", error);
    self.postMessage({
      type: "error",
      error: error.message || "未知错误",
    });
  }
};

self.onerror = function (error) {
  console.error("Worker 错误:", error);
  self.postMessage({
    type: "error",
    error: error.message || "未知错误",
  });
};

```